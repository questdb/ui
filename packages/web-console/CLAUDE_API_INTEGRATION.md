# Claude API Integration for SQL Query Explanations

This document describes the Claude API integration that allows users to get AI-powered explanations for their SQL queries directly in the QuestDB Web Console.

## Features

- 🔐 **Secure API Key Management** - Keys stored locally with obfuscation
- 🤖 **AI-Powered Explanations** - Uses Claude 3.5 Sonnet for high-quality explanations  
- 💬 **Smart Comment Insertion** - Adds formatted SQL comments above queries
- ⚡ **Rate Limiting** - Built-in protection against API abuse
- 🛡️ **Error Handling** - Comprehensive error handling for different scenarios
- 🌐 **Browser Support** - Uses official Anthropic SDK with browser support enabled

## How It Works

1. **Setup**: User configures Claude API key via settings button in toolbar
2. **Usage**: User positions cursor in SQL query and clicks "Explain" button
3. **Processing**: Query is sent to Claude API via official Anthropic SDK
4. **Result**: AI explanation inserted as formatted comment above query

## Implementation Details

### Anthropic SDK Integration

The integration uses the official [@anthropic-ai/sdk](https://github.com/anthropics/anthropic-sdk-typescript) with browser support explicitly enabled:

```typescript
const anthropic = new Anthropic({
  apiKey: apiKey,
  dangerouslyAllowBrowser: true
})
```

**Note**: The `dangerouslyAllowBrowser: true` flag is required because the SDK disables browser support by default to prevent accidental exposure of API keys. In our implementation, we handle this safely by:

- 🔒 **Local Storage Only** - API keys never leave the user's browser
- 🚫 **No Server Communication** - Keys are never sent to QuestDB servers
- 🎯 **User-Controlled** - Users explicitly provide and manage their own keys
- 🔐 **Obfuscated Storage** - Keys are Base64 encoded in localStorage

### SDK Benefits

- ✅ **Official Support** - Using Anthropic's official TypeScript SDK
- ✅ **Type Safety** - Full TypeScript support with proper types
- ✅ **Error Handling** - Built-in error classes for different scenarios
- ✅ **Automatic Retries** - SDK handles retries and exponential backoff
- ✅ **Browser Compatible** - Designed to work in browser environments when enabled

## Security & Privacy

### Client-Side Only
The entire integration runs client-side in the user's browser:
- API keys are stored in browser localStorage with Base64 obfuscation
- Direct communication between browser and Anthropic API
- QuestDB server never sees or handles Claude API keys
- Users have full control over their API usage and billing

### API Key Safety
- Keys are masked in the UI (shows `sk-ant-••••••••-key4` format)
- No logging or console output of API keys
- Keys are only used for direct API calls to Anthropic
- Users can remove keys at any time

## Usage Instructions

### Setup Process
1. **Get API Key**: Visit [Anthropic Console](https://console.anthropic.com/settings/keys) to create an API key
2. **Configure in QuestDB**: Click the settings gear (⚙️) in the top toolbar
3. **Enter Key**: Paste your API key in the Claude API Settings dialog
4. **Test Connection**: Click "Test Key" to verify the key works
5. **Save**: Your key is stored locally and ready to use

### Using Query Explanations
1. **Write SQL**: Create or position cursor in any SQL query
2. **Click Explain**: Use the lightbulb (💡) button next to Run/Stop buttons
3. **Wait**: The system sends your query to Claude for explanation
4. **Review**: AI explanation appears as a comment above your query

### Example Output
```sql
/*
 * AI Explanation:
 * This query retrieves all customer records from the customers table where
 * the customer's registration date is within the last 30 days. It's useful
 * for finding recently registered customers and analyzing user growth
 * patterns.
 */
SELECT * FROM customers 
WHERE created_date > NOW() - INTERVAL '30 days';
```

### Line Wrapping
The system automatically wraps long explanations to maintain readable line lengths (80 characters maximum):

```sql
/*
 * AI Explanation:
 * This complex query performs a multi-table join operation between the
 * orders, customers, and products tables to calculate the total revenue
 * generated by each customer segment over the last fiscal quarter. The
 * results are grouped by customer type and sorted by total spending to
 * identify high-value customer segments for targeted marketing campaigns.
 */
SELECT c.customer_type, SUM(o.total_amount) as revenue
FROM customers c 
JOIN orders o ON c.id = o.customer_id
WHERE o.order_date >= '2024-01-01'
GROUP BY c.customer_type
ORDER BY revenue DESC;
```

## Error Handling

The integration handles various error scenarios gracefully:

### Common Errors
- **Invalid API Key** - Clear validation with specific error messages
- **Rate Limiting** - Automatic retry with user-friendly feedback  
- **Network Issues** - Timeout and connection error handling
- **Quota Exceeded** - Clear messaging when API usage limits are reached

### Error Messages
Users see helpful error messages:
- "Invalid API key. Please check your Claude API settings."
- "Rate limit exceeded. Please wait before trying again."
- "Network error. Please check your internet connection."


## Implementation Details

### Files Modified/Created

1. **Storage Layer**
   - `src/utils/localStorage/types.ts` - Added `CLAUDE_API_KEY` enum
   - `src/utils/localStorage/crypto.ts` - API key obfuscation utilities
   - `src/providers/LocalStorageProvider/` - Extended for API key storage

2. **Claude API Service**
   - `src/utils/claude/index.ts` - Complete API client with error handling

3. **UI Components**
   - `src/components/ClaudeApiSettings/` - API key management interface
   - `src/components/ExplainQueryButton/` - Query explanation button

4. **Integration Points**
   - `src/scenes/Editor/ButtonBar/` - Added Explain button
   - `src/components/TopBar/toolbar.tsx` - Added settings access

### Security Considerations

- API keys are obfuscated (Base64) in localStorage
- Keys are masked in UI display
- No logging or exposure of API keys in browser console
- Rate limiting prevents API abuse

### Error Handling

The implementation handles various error scenarios:
- **Invalid API Key** - Clear validation and error messages
- **Rate Limiting** - Automatic retry with backoff
- **Network Errors** - User-friendly error messages
- **CORS Errors** - Specific guidance about the limitation

## Future Enhancements

Once the CORS issue is resolved with a server-side proxy:

1. **Caching** - Store explanations to reduce API calls
2. **Batch Processing** - Explain multiple queries at once
3. **Custom Prompts** - Allow users to customize explanation style
4. **Multiple Providers** - Support other AI services (OpenAI, etc.)
5. **Query History** - Track explained queries
6. **Export Functionality** - Export queries with explanations

## Testing

The integration has been tested for:
- ✅ TypeScript compilation
- ✅ Webpack build process
- ✅ Component rendering
- ✅ Error handling flows
- ✅ Anthropic SDK integration
- ✅ Browser compatibility

## Conclusion

The Claude API integration is **fully functional and ready to use**! Users can:

1. Configure their Claude API key in the QuestDB Web Console
2. Get AI-powered explanations for any SQL query
3. Enjoy a seamless, client-side experience with no server dependencies

The integration uses the official Anthropic SDK with proper browser support, ensuring reliability and type safety. All API communication happens directly between the user's browser and Anthropic's servers, maintaining privacy and giving users full control over their API usage.